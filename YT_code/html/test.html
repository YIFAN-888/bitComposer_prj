<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script type= "text/javascript" src="js/abcjs-basic-min.js"></script>
        <script type= "text/javascript" src="js/class.js"></script>
    </head>
    <body>
        <textarea  id="p"></textarea>
        <div id="content"></div>
        <script type='text/javascript'>
            //"A,,", "^A,,", "B,,", "C,", "^C,", "D,", "^D,", "E,", "F,", "^F,", "G,",
            // "^G,", "A,", "^A,", "B,", "C", "^C", "D", "^D", "E", "F", "^F", "G", "^G",
            //"A", "^A", "B", "C'", "^C'", "D'"
            const keyMap = [
                { pcKey: "a", pianoKey: 0 , abcKey: "A,,"},
                { pcKey: "q", pianoKey: 1 , abcKey: "^A,,"},
                { pcKey: "s", pianoKey: 2 , abcKey: "B,,"},
                { pcKey: "d", pianoKey: 3 , abcKey: "C,"},
                { pcKey: "w", pianoKey: 4 , abcKey: "^C,"},
                { pcKey: "f", pianoKey: 5 , abcKey: "D,"},
                { pcKey: "e", pianoKey: 6 , abcKey: "^D,"},
                { pcKey: "g", pianoKey: 7 , abcKey: "E,"},
                { pcKey: "h", pianoKey: 8 , abcKey: "F,"},
                { pcKey: "r", pianoKey: 9 , abcKey: "^F,"},
                { pcKey: "j", pianoKey: 10 , abcKey: "G,"},
                { pcKey: "t", pianoKey: 11 , abcKey: "^G,"},
                { pcKey: "k", pianoKey: 12 , abcKey: "A,"},
                { pcKey: "y", pianoKey: 13 , abcKey: "^A,"},
                { pcKey: "l", pianoKey: 14 , abcKey: "B,"},
                { pcKey: ";", pianoKey: 15 , abcKey: "C"},
                { pcKey: "u", pianoKey: 16 , abcKey: "^C"},
                { pcKey: "z", pianoKey: 17 , abcKey: "D"},
                { pcKey: "i", pianoKey: 18 , abcKey: "^D"},
                { pcKey: "x", pianoKey: 19 , abcKey: "E"},
                { pcKey: "c", pianoKey: 20 , abcKey: "F"},
                { pcKey: "o", pianoKey: 21 , abcKey: "^F"},
                { pcKey: "v", pianoKey: 22 , abcKey: "G"},
                { pcKey: "p", pianoKey: 23 , abcKey: "^G"},
                { pcKey: "b", pianoKey: 24 , abcKey: "A"},
                { pcKey: "@", pianoKey: 25 , abcKey: "^A"},
                { pcKey: "n", pianoKey: 26 , abcKey: "B"},
                { pcKey: "m", pianoKey: 27 , abcKey: "C'"},
                { pcKey: "[", pianoKey: 28 , abcKey: "^C'"},
                { pcKey: ",", pianoKey: 29 , abcKey: "D'"},
                { pcKey: "Delete", pianoKey: 30},
            ];

            var interval_start = 0; //カーソル範囲のはじめ
            var interval_end = 0;  //カーソル範囲の終わり
            
            var context = "";
            var index = 0;
            var input = document.getElementById("p"); //テキストボックス
            var note_list = new Array();
            //引数: 音程,音価, カーソルはじめ, カーソル終わり
            note_list.push('', 0, 0, 0);

            function edit_note(obj){
                
                if(obj.pianoKey > 29){
                    if(index > 0){
                        delete note_list[index];
                        interval_end = interval_start
                        input.value = input.value.slice(0, interval_end) //テキスト文字の削減
                        interval_start = interval_end - length[--index] //範囲の削減

                        console.log("はじめ" + interval_start)
                        console.log("終わり" + interval_end)
                        input.setSelectionRange(interval_start, interval_end)
                        input.focus()
                    }
                }
                else{
                    console.log(obj.abcKey)
                    context = obj.abcKey + ' '
                    //テキスト文字の追加
                    interval_start = interval_end;
                    interval_end = interval_start + context.length;

                    note_list.push(new Note(context, 0, interval_start, interval_end))
                    // //15
                    // if(index % 15 === 0){
                    //     context +='\n'
                    // }
                    
                    input.value += context;
                    input.focus()
                    input.setSelectionRange(interval_start, interval_end) // 範囲選択の設定
                }
            }
            
            document.onkeydown = function(event){
                const obj = keyMap.find((item) => item.pcKey == event.key)
                if(typeof obj !== "undefined"){
                    edit_note(obj)
                    event.preventDefault(); //key入力無効
                }
            }

            document.onclick = function(event){
                if(document.activeElement.id === "p"){
                    input.setSelectionRange //テキストボックスのカーソル位置を取得
                    foreach(note in note_list){
                        if(note.get_e_pos >= )
                    }
                }
            }
            //送信ボタンを押したらclassから取り出す
            new ABCJS.Editor("p", {paper_id: "content"});
        </script>
    </body>
</html>