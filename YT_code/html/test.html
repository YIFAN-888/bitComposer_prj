<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script type= "text/javascript" src="js/abcjs-basic-min.js"></script>
        <script type="text/javascript" src="js/class.js"></script>
    </head>
    <body>
        <textarea  id="p" readonly="readonly"></textarea>
        <div id="content"></div>
        <script type='text/javascript'>
            //"A,,", "^A,,", "B,,", "C,", "^C,", "D,", "^D,", "E,", "F,", "^F,", "G,",
            // "^G,", "A,", "^A,", "B,", "C", "^C", "D", "^D", "E", "F", "^F", "G", "^G",
            //"A", "^A", "B", "C'", "^C'", "D'"
            const keyMap = [
                { pcKey: "a", pianoKey: 0 , abcKey: "A,,"},
                { pcKey: "q", pianoKey: 1 , abcKey: "^A,,"},
                { pcKey: "s", pianoKey: 2 , abcKey: "B,,"},
                { pcKey: "d", pianoKey: 3 , abcKey: "C,"},
                { pcKey: "w", pianoKey: 4 , abcKey: "^C,"},
                { pcKey: "f", pianoKey: 5 , abcKey: "D,"},
                { pcKey: "e", pianoKey: 6 , abcKey: "^D,"},
                { pcKey: "g", pianoKey: 7 , abcKey: "E,"},
                { pcKey: "h", pianoKey: 8 , abcKey: "F,"},
                { pcKey: "r", pianoKey: 9 , abcKey: "^F,"},
                { pcKey: "j", pianoKey: 10 , abcKey: "G,"},
                { pcKey: "t", pianoKey: 11 , abcKey: "^G,"},
                { pcKey: "k", pianoKey: 12 , abcKey: "A,"},
                { pcKey: "y", pianoKey: 13 , abcKey: "^A,"},
                { pcKey: "l", pianoKey: 14 , abcKey: "B,"},
                { pcKey: ";", pianoKey: 15 , abcKey: "C"},
                { pcKey: "u", pianoKey: 16 , abcKey: "^C"},
                { pcKey: "z", pianoKey: 17 , abcKey: "D"},
                { pcKey: "i", pianoKey: 18 , abcKey: "^D"},
                { pcKey: "x", pianoKey: 19 , abcKey: "E"},
                { pcKey: "c", pianoKey: 20 , abcKey: "F"},
                { pcKey: "o", pianoKey: 21 , abcKey: "^F"},
                { pcKey: "v", pianoKey: 22 , abcKey: "G"},
                { pcKey: "p", pianoKey: 23 , abcKey: "^G"},
                { pcKey: "b", pianoKey: 24 , abcKey: "A"},
                { pcKey: "@", pianoKey: 25 , abcKey: "^A"},
                { pcKey: "n", pianoKey: 26 , abcKey: "B"},
                { pcKey: "m", pianoKey: 27 , abcKey: "C'"},
                { pcKey: "[", pianoKey: 28 , abcKey: "^C'"},
                { pcKey: ",", pianoKey: 29 , abcKey: "D'"},
                { pcKey: "Delete", pianoKey: 30},
            ]

            var interval_start = 0 //カーソル範囲のはじめ
            var interval_end = 0  //カーソル範囲の終わり
            var context = ""
            var index = 0 
            var input = document.getElementById("p") //テキストボックス
            var note_list = new Array()
            note_list.push(new Note("", 0, 0));

            function sort_insert(index, list, li_len, text_length){
            	for(i = li_len-1; i > index; i--){
            		obj = list[i-1];
	            	list[i-1] = list[i];
	            	list[i] = obj;
            		list[i].set_s_pos = list[i].get_s_pos + text_length;
            		list[i].set_e_pos = list[i].get_e_pos + text_length;
            	}            	
            }
            function sort_delete(index, list, text_length){
                
                
                for(i = index; i < list.length; i++){
            		list[i].set_s_pos = list[i].get_s_pos - text_length;
            		list[i].set_e_pos = list[i].get_e_pos - text_length;
            	}
            	note_list.splice(index, 1)
            	console.log(note_list)
            }
            function edit_note(obj){
                
                if(obj.pianoKey > 29){
                    if(index > 0){
                        sort_delete(index, note_list, note_list[index].get_note.length)
                        index--; //範囲の削減
                        
                    }
                }
                else{
                	context = obj.abcKey + ' '
                    note_list.push(new Note(context, 0, note_list[index].get_e_pos))
                    index++;
                    sort_insert(index, note_list, note_list.length, context.length)
                    console.log(note_list)
                }
                interval_start = note_list[index].get_s_pos
                interval_end = note_list[index].get_e_pos

                innerText ="";
                note_list.forEach(element => {
                    innerText += element.get_note;
                });
                input.value = innerText;
                input.setSelectionRange(interval_start, interval_end)
                input.focus()
                event.preventDefault(); //key入力無効
            }
            
            document.onkeydown = function(event){
                const obj = keyMap.find((item) => item.pcKey == event.key)
                if(typeof obj !== "undefined"){
                	edit_note(obj)
                }
                
            }

            document.onclick = function(event){
                if(document.activeElement.id === "p"){
                    input.setSelectionRange //テキストボックスのカーソル位置を取得

                    for(i = 0; i < note_list.length; i++){
                        
                        if(note_list[i].get_s_pos === input.selectionStart
                        && note_list[i].get_e_pos >= input.selectionEnd){
                            index = i;
                            break;
                        }
                    }
                    
                    interval_start = note_list[index].get_s_pos;
                    interval_end = note_list[index].get_e_pos;
                    
                }
            }
            new ABCJS.Editor("p", {paper_id: "content"});
        </script>
    </body>
</html>